# Распределённая БД морских измерений (Control Center ↔ Ports ↔ Ships ↔ Solver)

Проект реализует распределённую БД PostgreSQL для экспертной системы морских исследований.  
Система разделена на четыре логических узла:

- **Control Center (Центр управления)** — задаёт справочники (НСИ), методики, показатели, типы/экземпляры устройств и базовые маршруты.
- **Ports (Порты)** — работают с маршрутами и рейсами, планируют выходы судов, синхронизируются с Центром.
- **Ships (Суда)** — выполняют рейсы, собирают измерения в офлайн‑режиме, по связи отгружают результаты.
- **Solver (Солвер)** — консолидирует измеренные данные со всех судов, строит агрегаты и аналитические отчёты.

В репозитории — полная схема SQL, сид‑данные, триггеры валидации, базовые представления и демо‑сценарий, иллюстрирующий полный путь:  
**“Планирование рейса → Сбор измерений → Консолидация → Отчёты”**.

---

## 1. Модель данных (кратко)

### 1.1 География и логистика

- **aquatories** — акватории (моря, океаны, заливы).  
- **ports** — порты, расположенные в акваториях.  
- **routes** — маршруты между портами (origin_port_id → dest_port_id).  
- **ships** — суда, выполняющие рейсы (home_port_id — базовый порт).  
- **voyages** — рейсы (экспедиции) судна по маршруту с жизненным циклом:
  - `PLANNED` → `ONGOING` → `COMPLETED` (в миграции добавляется `AWAITING_PICKUP`).

### 1.2 Оборудование судна

- **device_types** — типы измерительных устройств (гидрофон, термодатчик, pH‑метр и т.п.).  
- **devices** — конкретные экземпляры устройств (серийники, инвентарные номера).  
- **ship_equipment** — комплектация судна: какие устройства стоят на каком судне.  

### 1.3 Показатели и методики

- **units** — единицы измерения (mg/L, °C, pH…).  
- **indicators** — список измеряемых показателей (Nitrate, Temperature, pH).  
- **methods** — методики измерения конкретного показателя (например, “UV Nitrate Sensor Method” для Nitrate).  
- **method_usage** — какие типы устройств поддерживают какие методики (M:N связь типа устройства и методики).  
- **voyage_indicators** — какие показатели планируется измерять в конкретном рейсе (план измерений).

### 1.4 Фактические измерения и логи

- **measurements** — фактически измеренные значения:
  - `voyage_id` — рейс, в рамках которого выполнено измерение,
  - `indicator_id` — измеряемый показатель,
  - `device_id` — устройство (если измерение бортовое),
  - `method_id` — методика (может быть определена по устройству),
  - `unit_id` — единица измерения,
  - `value`, `measured_at`.
- **logs** — технический журнал (не входит в “14 сущностей”, используется триггерами для аудита).

---

## 2. Схема узлов и шардирования

### 2.1 Узлы

1. **Узел 1 — Control Center (Центр управления)**  
   Основная база НСИ и методик:
   - PRIMARY для:
     - `aquatories`, `ports`,  
     - `ships`,  
     - `device_types`, `devices`, `ship_equipment`,  
     - `units`, `indicators`,  
     - `methods`, `method_usage`.
   - PRIMARY/MASTER для планирования:
     - `routes`, `voyages`, `voyage_indicators`.

2. **Узел 2 — Ports (Порты)**  
   Рабочий узел в порту:
   - RO‑копии (реплика РОК/МС) для НСИ: акватории, порты, суда, устройства, методики, показатели, единицы.
   - READ/WRITE для локального планирования рейсов и маршрутов (двусторонняя логическая репликация `routes`, `voyages`, `voyage_indicators`):
     - изменения маршрутов/рейсов на порту уходят на Центр, оттуда разводятся на другие порты.

3. **Узел 3 — Ships (Суда)**  
   Бортовые БД (оффлайн):
   - лёгкая RO‑выборка справочников (подмножество НСИ, нужное данному судну: его `ship_equipment`, `voyages`, `voyage_indicators`, связанные `routes`, `ports`, `indicators`, `units`, `methods`).
   - PRIMARY/MASTER для измерений `measurements` (родовые данные рождаются именно здесь).  
   При появлении связи (в порту или через спутник) измерения реплицируются:
   - **Ships → Solver** (консолидация),
   - при необходимости копии — в порт или Центр.

4. **Узел 4 — Solver (Солвер)**  
   Консолидирующий узел:
   - PRIMARY для глобальной таблицы `measurements` (объединение потоков с разных судов).
   - PRIMARY для аналитических представлений:
     - `top10_nitrate_locations`,
     - `expedition_report`,
     - `avg_param_values_by_month`,
     - `ship_report`.
   - Может предоставлять RO‑витрины вверх/вниз (в Центр и Порты) через логическую репликацию или FDW.

### 2.2 Схема шардирования

Логика шардинга и репликации:

- **Зелёный слой (НСИ, РОК/МС)**  
  Таблицы: `aquatories`, `ports`, `ships`, `device_types`, `devices`, `ship_equipment`,  
  `units`, `indicators`, `methods`, `method_usage`.  
  - PRIMARY: узел Control Center.  
  - RO: узлы Ports, Ships, Solver.  
  - Механизм: инкрементальная логическая репликация 1 раз в сутки или по событию.

- **Синий слой (оперативное планирование)**  
  Таблицы: `routes`, `voyages`, `voyage_indicators`.  
  - PRIMARY логически на Центре, но:
    - Ports имеют RW‑копию с двусторонней репликацией (Central ↔ Ports),
    - Ships получают только свои `voyages` и связанные `voyage_indicators` (RO).
  - Логика:
    - Центр выдаёт план маршрутов и рейсов → Порты.
    - При правках с порта изменения реплицируются на Центр и оттуда — на другие порты.

- **Бордовый слой (сбор результатов)**  
  Таблица: `measurements`.  
  - PRIMARY локально на Ships (место рождения данных).
  - Консолидация на Solver:
    - Ships → Solver (логическая репликация/merge),
    - Solver хранит глобальный срез измерений, строит отчёты.
  - При необходимости Solver может:
    - раздавать агрегированные витрины в Центр и Порты (RO).

---

## 3. Структура репозитория

Рекомендуемая структура (аналогично учебному примеру):

```text
sql/
  base/
    extensions.sql      -- расширения (uuid-ossp и т.п.)
    schema.sql          -- ядро схемы (все 14 сущностей + logs)
    seed_full.sql       -- справочники НСИ, судна, маршруты, рейсы, начальные данные
    seed_bulk.sql       -- генерация большого объёма измерений
    triggers.sql        -- функции и триггеры валидации/логирования
    views.sql           -- аналитические представления
  demo/
    demo.sql            -- демо-сценарий: новый рейс, измерения, отчёт
  init_schema.sql       -- общий init (extensions + schema + triggers + views)
  seed_data.sql         -- запуск seed_full + seed_bulk
  migrate_to_pickup_flow.sql -- пример миграции жизненного цикла рейсов
```

### 3.1 base/extensions.sql

- Создание расширений, как минимум:

```sql
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
```

### 3.2 base/schema.sql

- Все DDL:
  - создание enum `voyage_status`,
  - таблицы:  
    `aquatories`, `ports`,  
    `routes`, `ships`, `voyages`,  
    `device_types`, `devices`, `ship_equipment`,  
    `units`, `indicators`, `methods`, `method_usage`, `voyage_indicators`,  
    `measurements`, `logs`.

### 3.3 base/seed_full.sql

- Справочные данные и небольшие демо‑наборы:
  - `units` (mg/L, °C, pH),
  - `indicators` (Nitrate, Temperature, pH),
  - `device_types`, `devices`, `method_usage`,
  - `aquatories`, `ports`,
  - `ships`, `ship_equipment`,
  - `routes`, `voyages`, `voyage_indicators`.

### 3.4 base/seed_bulk.sql

- Массовая генерация измерений (с использованием `generate_series`):
  - Почасовые нитрат‑измерения для RV Alpha, RV Beta.
  - Дневные нитрат/температура‑измерения для RV Gamma.

### 3.5 base/triggers.sql

- Функции и триггеры:

1. `fn_validate_measurement` + `trg_measurement_validate`  
   - проверка:
     - что устройство умеет измерять данный показатель по заданной методике,
     - что устройство действительно стоит на корабле, выполняющем рейс,
     - что показатель входит в `voyage_indicators` (если план есть),
     - что значение в пределах допустимого диапазона индикатора.

2. `fn_validate_voyage_status` + `trg_voyage_status_validate`  
   - контроль переходов статусов `voyages`:
     - `PLANNED → ONGOING → COMPLETED` (в миграции добавляется `AWAITING_PICKUP`).

3. `fn_log_voyage_created`, `fn_log_voyage_status_change` и триггеры:
   - автоматическая запись в `logs` при создании рейсов и смене их статуса.

### 3.6 base/views.sql

- Аналитические представления:

1. `top10_nitrate_locations` — топ‑10 портов/акваторий по среднему уровню нитратов.  
2. `expedition_report` — отчёт по рейсам (длительность, кол‑во измерений, кол‑во параметров).  
3. `avg_param_values_by_month` — средние значения параметров по месяцам и годам.  
4. `ship_report` — сводка по судам (кол‑во рейсов, измерений, дата последнего завершённого рейса).

---

## 4. Инициализация и запуск

### 4.1 Быстрый старт (один узел, демо)

1. Создать БД, например:

```bash
createdb marine_demo
```

2. Выполнить начальную инициализацию (через psql или DBeaver):

```bash
psql -d marine_demo -f sql/init_schema.sql
psql -d marine_demo -f sql/seed_data.sql
```

3. (Опционально) Запустить демо‑сценарий:

```bash
psql -d marine_demo -f sql/demo/demo.sql
```

4. Проверить представления:

```sql
SELECT * FROM top10_nitrate_locations;
SELECT * FROM expedition_report;
SELECT * FROM avg_param_values_by_month;
SELECT * FROM ship_report;
```

### 4.2 Дополнительная нагрузка

По желанию — добавить большой объём измерений вручную:

```bash
psql -d marine_demo -f sql/base/seed_bulk.sql
```

---

## 5. Ручной сценарий (имитация распределённой среды)

В учебном стенде можно поднять несколько инстансов PostgreSQL (или контейнеров) и логически разделить их роли:

### Узел 1 — Control Center

- Инициализировать схемой (`schema.sql`), триггерами (`triggers.sql`) и представлениями (`views.sql`).
- Загрузить справочники (`seed_full.sql` без `measurements`).
- Настроить публикации (`CREATE PUBLICATION`) для:
  - справочников НСИ (`aquatories`, `ports`, `ships`, `device_types`, `devices`, `ship_equipment`, `units`, `indicators`, `methods`, `method_usage`);
  - планирования (`routes`, `voyages`, `voyage_indicators`).

### Узел 2 — Ports

- Подписаться (`CREATE SUBSCRIPTION`) на справочники и планирование из Центра.
- Локально работать с `routes`, `voyages`, `voyage_indicators` (с двусторонней логической репликацией).

### Узел 3 — Ships

- Подписаться на минимальный набор НСИ (свой `ship`, `ship_equipment`, нужные `indicators`, `units`, `methods`, маршруты и рейсы).
- Локально вставлять записи в `measurements` (офлайн).
- При появлении связи — публиковать таблицу `measurements` (или её партиции по судну) на Solver.

### Узел 4 — Solver

- Подписаться на `measurements` со всех судов.
- Выполнять консолидацию и анализ (используя представления `views.sql`).
- (Опционально) публиковать агрегированные витрины (например, только месячные или рейсовые агрегаты) обратно в Центр/Порты.

Конкретные команды `CREATE PUBLICATION` / `CREATE SUBSCRIPTION` зависят от схемы стенда, но структура таблиц и ключей уже готова под такой сценарий.

---

## 6. Диагностика

### 6.1 Проверка логов

```sql
SELECT *
FROM logs
ORDER BY log_time DESC
LIMIT 20;
```

### 6.2 Проверка корректности измерений

- Попробовать вставить `measurement` с устройством, которое не умеет измерять указанный показатель — ожидается ошибка триггера `fn_validate_measurement`.
- Попробовать изменить статус рейса с `PLANNED` сразу на `COMPLETED` — ожидается ошибка `fn_validate_voyage_status`.

### 6.3 Проверка отчётности

```sql
SELECT * FROM expedition_report ORDER BY voyage_id;
SELECT * FROM ship_report ORDER BY ship;
SELECT * FROM avg_param_values_by_month ORDER BY indicator, year, month;
```

---

## 7. Примечания

- Проект предназначен для **демонстрации и обучения** концепциям распределённых БД и обработки научных измерений.
- UI отсутствует, вся работа идёт через SQL‑скрипты (`psql`, DBeaver, DataGrip и т.п.).
- Логическая репликация и шардирование реализуются стандартными средствами PostgreSQL (logical replication, FDW) поверх данной схемы.
